<script>
    /*global App,Cbank*/
    Cbank=App.page_accounts_clientbank={
        main_acc_code:311,
        current_check:{},
        init:function(){
            
        },
        renderCheckView:function(){
           App.renderTpl("Cbank_check_view",this.current_check);
           this.renderCorrespondent();
        },
        renderCorrespondent:function(){
            $.post("AccountsBank/getCorrespondentStats/",{check_id:this.current_check.check_id},function(resp){
		var corr_data=App.json(resp);
		App.user.setPassiveCompany(corr_data.pcomp);
                App.renderTpl("Cbank_check_corresp",corr_data);
            });
        },
        transClick:function(node){
	    var trans_type,amount;
	    var date=this.current_check.tdate;
	    var description=this.current_check.assignment;
            var acc_code=$(node).attr('data-acc-code');
            if( this.current_check.debit ){
                trans_type=acc_code+"_"+this.main_acc_code;
		amount=this.current_check.debit;
            } else {
                trans_type=this.main_acc_code+"_"+acc_code;
		amount=this.current_check.credit;
            }
	    console.log(this.current_check);
            this.transCreate(trans_type,description,amount,0,date);
        },
        transCreate:function( trans_type, description, amount, trans_ref, date ){
            var data={
                trans_id:0,
                trans_date:date,
                amount:amount,
                trans_ref:trans_ref||null,
                trans_type:trans_type||'',
                description:description||'',
                passive_company_id:App.pcomp?App.pcomp.company_id:0,
                current_acc_code:Cbank.main_acc_code,
                using_alt_currency:false
            };
	    console.log(data);
            if(App.pcomp){
                data.passive_company_id=App.pcomp.company_id || 0;
                data.label=App.pcomp.label || '?';
            }
            App.loadWindow('page/accounts/trans_edit',data).progress(function(status,data){
                if( status==='save' || status==='delete' ){
                    $('#account_ledger_dg').datagrid('reload');
                }
            });
        },
        payTrans:function(){
            var row=$('#account_ledger_dg').datagrid('getSelected');
            if( row.trans_status ){
                var status=row.trans_status.split(' ')[0];
                if( "unpayed partly payed".indexOf(status)>-1 ){
                    this.rowCreate(null,null,row.debit||row.credit,row.trans_id);
                } else if( "closing closed".indexOf(status)>-1 ){
                    App.flash("Проводка уже связана.");
                }
            }
        },
        list:{
            styler:function(value, row, index) {
                return row.debit>0?"color:red;font-weight:bold":"color:green;font-weight:bold";
	    },
            onSelect:function(){
                var row=$('#account_clientbank_dg').datagrid('getSelected');
                if( row ){
                    Cbank.current_check=row;
                    Cbank.renderCheckView();
                }
                $('#account_clientbank_dg').datagrid('resize');
            }
        }
    };
</script>
<style>
    .trans_pay_table{
	display:table;
	width: 100%;
	border-right: 1px solid #9cd;
	border-top: 1px solid #9cd;
	margin-top: 8px;
    }
    .trans_pay_table_head div{
	display: table-cell;
	border-bottom: 1px solid #9cd;
	border-left: 1px solid #9cd;
	padding: 2px;
    }
    .trans_pay_table_row div{
	display: table-cell;
	border-bottom: 1px solid #9cd;
	border-left: 1px solid #9cd;
	padding: 4px;
    }
    .trans_pay_table_row:hover{
	background-color: #ffa;
	cursor: pointer;
    }
</style>
<div style="width:400px;display: inline-block;vertical-align: top;">
    <div class="easyui-panel" title="Корреспондент" id="Cbank_check_corresp" style="margin-bottom: 3px;">
        <h4>{{pcomp.company_name}}</h4>
	<div>
	    {{favs}}
	    <div class="rounded">
                <b class="tag">{{acc_code}}</b> {{label}} {{if balance}}(<b>{{balance}}</b>){{/if}} 
                <button class="tiny_button" style="float: right;" 
                        data-acc-code="{{acc_code}}" 
                        onclick="Cbank.transClick(this)">Провести</button>
                {{if suggs}}
                <div class="trans_pay_table">
		    <div style="display: table-row;font-weight: bold;" class="trans_pay_table_head">
                        <div style="width:22px;text-align: center">!</div>
                        <div style="width:70px;">Дата</div>
                        <div style="display: table-cell">Пояснение</div>
                        <div style="width:50px;">Сумма</div>
                    </div>
                    {{suggs}}
		    <div style="display: table-row;" class="trans_pay_table_row">
                        <div style="text-align: center"><img src="img/{{code}}.png" title="{{descr}}"></div>
                        <div>{{date}}</div>
                        <div>{{description}}</div>
                        <div style="text-align: right">{{amount}}</div>
                    </div>
                    {{/suggs}}
                </div>
                {{/if}}
		<hr>
	    </div>
	    {{/favs}}
            <div style="text-align: center;padding: 3px;">
                <button class="tiny_button">Провести по другому счету</button>
            </div>
	</div>
    </div>
    <div class="easyui-panel" title="Платежное поручение" id="Cbank_check_view">
        <table>
            <tr>
                <td class="bank_property_name">Контрагент:</td>
                <td class="bank_property_value">{{correspondent_name}}</td>
            </tr>
            <tr>
                <td class="bank_property_name">Код:</td>
                <td class="bank_property_value">{{correspondent_code}}</td>
            </tr>
            <tr>
                <td class="bank_property_name">Счет:</td>
                <td class="bank_property_value">{{correspondent_account}}</td>
            </tr>
            <tr>
                <td class="bank_property_name">Банк:</td>
                <td class="bank_property_value"><i>{{correspondent_bank_code}}</i> {{correspondent_bank_name}}</td>
            </tr>
            <tr>
                <td colspan="2" align="center" height="30">&nbsp;</td>
            </tr>
            <tr>
                <td class="bank_property_name">Номер:</td>
                <td class="bank_property_value">№{{number}} от <b>{{tdate}}</b></td>
            </tr>
            <tr>
                <td class="bank_property_name">Сумма:</td>
                <td class="bank_property_value"><b><span style="color:red">{{debit}}</span><span style="color:green">{{credit}}</span>грн</b></td>
            </tr>
            <tr>
                <td class="bank_property_name">Назначение:</td>
                <td class="bank_property_value">{{assignment}}</td>
            </tr>
        </table>
    </div>
</div>
<div style="display: inline-block;vertical-align: top;">
    <div style="clear:both">
	<div style="float: left;font-weight: bold;padding-top: 8px;">
	    <img src="img/table16.png" style="width:16px;height: 16px;"> Платежные поручения
	</div>
	<div style="float: right">
	    <span class="icon-24 icon-create" title="Добавить" onclick="Ledger.list.rowCreate();"> </span>
	    <span class="icon-24 icon-change" title="Изменить" onclick="Ledger.list.rowUpdate();"> </span>
	    <span class="icon-24 icon-delete" title="Удалить" onclick="Ledger.list.rowDelete();"> </span>
	    <span class="icon-24 icon-tablefilter" title="Фильтр таблицы" onclick="Ledger.list.toggleFilter()"> </span>
	    <span class="icon-24 icon-refresh" title="Обновить" onclick="$('#account_clientbank_dg').datagrid('reload')"> </span>
	    <span class="icon-24" style="background-image: url(img/file_download.png);background-repeat: no-repeat" title="Скачать таблицу" onclick="Ledger.list.out('.xlsx');"> </span>
	    <span class="icon-24 icon-print" title="Напечатать" onclick="Ledger.list.out('.print');"> </span>
	</div>
    </div>
    <table id="account_clientbank_dg" class="easyui-datagrid" style="width:740px;"
	   data-options="
	   idField:'check_id',
	   url:'AccountsBank/clientBankGet/311/',
	   rowStyler:Cbank.list.rowStyler,
	   pagination:true,
	   pageSize:25,
	   pageList:[25,50,100,500,1000],
	   singleSelect:true,
	   remoteFilter:true,
	   onSelect:Cbank.list.onSelect,
	   onLoadSuccess:function(){$('#account_clientbank_dg').datagrid('resize');}">
        <thead>
            <th data-options="width:25,field:'status',formatter:App.datagrid.tooltip"></th>
            <th data-options="width:70,field:'tdate'">Дата</th>
            <th data-options="width:200,field:'correspondent_name'">Корреспондент</th>
            <th data-options="width:300,field:'assignment'">Назначение</th>
            <th data-options="width:70,field:'debit',formatter:App.formatNum,align:'right',styler:Cbank.list.styler">Дебит</th>
            <th data-options="width:70,field:'credit',formatter:App.formatNum,align:'right',styler:Cbank.list.styler">Кредит</th>
        </thead>
    </table>
</div>