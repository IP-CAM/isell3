<script type="text/javascript">
    /* global App */
    Tedit = App.page_accounts_trans_edit = {
	init: function () {
	    this.node.window({
		title: 'Свойства проводки',
		width: 450,
		height: 300,
		onClose: function(){
		    App.page_accounts_trans_edit.handler.notify('close',App.page_accounts_trans_edit.data);
		    App.page_accounts_trans_edit.node.window('destroy');
		    App.page_accounts_trans_edit.node.remove();
		    delete App.page_accounts_trans_edit,Tedit;
		}
	    });
	    App.setupForm("#trans_edit_frm",this.data,'use_inp_values');
	},
	initAfter:function(){
	    $('#page_accounts_trans_edit .validatebox-text').on('focus', function() {
		this.select();
	    });
	    this.calc();
	},
	pcompLoader: function (param, success, error) {
	    $.get('Company/listFetch/with_active', param, function (xhr) {
		var resp = App.json(xhr);
		success(resp[0] ? resp : []);
	    });
	},
	pcompOnSelect: function () {

	},
	pcompTree:function(){
	    App.loadWindow('page/company/tree',{}).progress(function(status,comp){
		if( status==='select' ){
		    $("#tedit_comp_cmb").combobox('setValue',comp.company_id);
		    $("#tedit_comp_cmb").combobox('setText',comp.label);
		    //alert(comp.toSource());
		}
	    });
	},
	transnameLoader: function (param, success, error) {
	    $.get('AccountsData/transNameListFetch/311', param, function (xhr) {
		var resp = App.json(xhr);
		success(resp[0] ? resp : []);
		if( !Tedit.data.trans_type && resp[0] ){
		    $('#tedit_trans_type_cmb').combobox('select',resp[0].trans_type);
		}
	    });
	},
	transnameEdit:function(){
	    var rows=$('#tedit_trans_type_cmb').combobox('getData');
	    var trans_type=$('#tedit_trans_type_cmb').combobox('getValue');
	    for(var i in rows){
		if( rows[i].trans_type === trans_type ){
		    App.loadWindow('page/accounts/trans_names',rows[i]).progress(function(status){
			if( status==='close' ){
			    $('#tedit_trans_type_cmb').combobox('reload');
			}
		    });
		    break;
		}
	    }
	},
	parser:function( node, text ){
	    var result=eval(text.toString().replace(',','.').match( /[\(\d\.\)\*\/\+-]*/ ).toString()) || 0;
	    if( $(node).textbox('options').precision ){
		result=Tedit.round(result,$(node).textbox('options').precision);
	    };
	    $(node).textbox('setValue',result);
	},
	round:function(num,precision){
	    return Math.round(num*Math.pow(10,precision))/Math.pow(10,precision) || 0;
	},
	calc:function( field ){
	    if( this.suppressUpdate ){
		return;
	    }
	    this.suppressUpdate=true;
	    var amount=$("#Tedit_amount").textbox('getValue');
	    var ratio=$("#Tedit_ratio").textbox('getValue');
	    var amount_alt=$("#Tedit_amount_alt").textbox('getValue');
	    if( field==='amount' ){
		if( ratio ){
		    $("#Tedit_amount_alt").textbox('setValue',this.round(amount/ratio,2));
		} else {
		    $("#Tedit_ratio").textbox('setValue',this.round(amount/amount_alt,5));
		}
	    }
	    if( field==='amount_alt' ){
		if( ratio ){
		    $("#Tedit_amount").textbox('setValue',this.round(amount_alt*ratio,2));
		} else {
		    $("#Tedit_ratio").textbox('setValue',this.round(amount/amount_alt,5));
		}
	    }
	    if( field==='ratio' ){
		if( amount ){
		    $("#Tedit_amount_alt").textbox('setValue',this.round(amount/ratio,2));
		} else {
		    $("#Tedit_amount").textbox('setValue',this.round(amount_alt*ratio,2));
		}
	    }
	    this.suppressUpdate=false;
	}
    };
</script>
<form id="trans_edit_frm">
    <div style="display: inline-block;width: 200px">
	<input style="width:95px" class="easyui-datebox" name="date" title="Дата">
	<input style="width:95px" class="easyui-textbox" name="amount" id="Tedit_amount" title="Сумма" data-options="
	       onChange:function(text){Tedit.parser(this,text);Tedit.calc('amount');},
	       precision:2">
    </div>
    <div style="display: inline-block;width: 200px">
	<input style="width:95px" class="easyui-textbox" name="ratio" id="Tedit_ratio" title="Курс" data-options="
	       onChange:function(text){Tedit.parser(this,text);Tedit.calc('ratio');},
	       precision:5">
	<input style="width:95px" class="easyui-textbox" name="amount_alt" id="Tedit_amount_alt" title="Сумма вал" data-options="
	       onChange:function(text){Tedit.parser(this,text);Tedit.calc('amount_alt');},
	       precision:2">
    </div>
    <input style="width:300px" class="easyui-combobox" id="tedit_comp_cmb" title="Контрагент" data-options="
	   valueField: 'company_id',
	   textField: 'label',
	   loader:Tedit.pcompLoader,
	   mode: 'remote',
	   method:'get',
	   onSelect: Tedit.pcompOnSelect,
	   icons: [{
		    iconCls:'icon-settings16',
		    handler: function(e){
			Tedit.pcompTree();
		    }
		}]
	   ">
    <input style="width:300px" class="easyui-combobox" id="tedit_trans_type_cmb" title="Проводка" data-options="
	   valueField: 'trans_type',
	   textField: 'trans_name',
	   url:'AccountsCore/transNameListFetch',
	   loader:Tedit.transnameLoader,
	   method:'get',
	   icons: [{
		    iconCls:'icon-settings16',
		    handler: function(e){
			Tedit.transnameEdit();
		    }
		}]
	   ">
    <input style="width:300px" class="easyui-textbox" title="Комментарий" data-options="
	   multiline:true,
	   height:66
	   ">
    <div style="text-align: center;margin-top: 15px;">
	<button type="submit"><img src="img/apply24.png" /> Сохранить</button>
	<button type="button" onclick="cancelTrans()"><img src="img/cancel24.png" /> Отменить</button>
	<button type="button" onclick="Tedit.node.window('close')"><img src="img/close24.png" /> Закрыть</button>
    </div>
</form>
