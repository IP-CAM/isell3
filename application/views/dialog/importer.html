<script>
    /*global App*/
    App.page_dialog_importer={
	label:'',
	init:function(){
	    this.node.window({
		width: 800,
		title: 'Импорт таблицы',
		height: 600,
		onClose: function () {
		    App.page_dialog_importer.node.window('destroy');
		    App.page_dialog_importer.handler.notify('close');
		    delete App.page_dialog_importer;
		}
	    });
	    this.label=this.data.label||'';
	    $("#page_dialog_importer_label").val(this.label);
	},
	up:function(filelist){
	    if( filelist.length ){
                App.page_dialog_importer.throbber(1);
		var url = 'Importer/Up/'+App.page_dialog_importer.label;
		var xhr = new XMLHttpRequest();
		var fd = new FormData();
		xhr.open("POST", url, true);
		xhr.onreadystatechange = function() {
		    if (xhr.readyState === 4 && xhr.status === 200) {
			if( xhr.responseText==='imported' ){
			    $('#page_dialog_importer_dg').datagrid('reload');
                            App.flash("Файл загружен.");
			} else {
			    App.flash("Не удалось загрузить "+xhr.responseText);
			}
                        App.page_dialog_importer.throbber(0);
		    }
		};
		fd.append("upload_file", filelist[0]);
		xhr.send(fd);
	    }
	},
        throbber:function(show){
            show?$("#page_dialog_importer_throbber").show():$("#page_dialog_importer_throbber").hide();
        },
	delete:function( mode ){
	    if( mode==='all' ){
		$('#page_dialog_importer_dg').datagrid('selectAll');
	    }
	    var rows=$('#page_dialog_importer_dg').datagrid('getSelections');
	    if( rows && confirm("Удалить выбранные строчки?") ){
		var row_ids=[];
		for(var i in rows){
		    row_ids.push(rows[i].row_id);
		}
		$.post("Importer/impDelete/",{row_ids:row_ids.join(',')},function(ok){
		    if( ok*1 ){
			App.flash("Удалено "+ok+" строк");
			$('#page_dialog_importer_dg').datagrid('reload');
		    } else {
			App.flash("Не удалось удалить строки");
		    }
		});
	    }
	    
	},
	filter:function( node ){
	    App.page_dialog_importer.label=node.value||'';
	    $('#page_dialog_importer_dg').datagrid('reload');
	},
	loader:function(param, success, error){
	    $.post('Importer/getRows/'+App.page_dialog_importer.label,param,function(xhr){
		success(App.json(xhr));
	    });
	}
	
    };
</script>
<style>
    #page_dialog_importer_throbber img{
        position: absolute;
        z-index:10;
        top: 130px;
        left: 50%;
    }
</style>
<div id="page_dialog_importer_throbber" style="display: none;position: relative;" >
    <img src="img/throbber_1.gif">
</div>
<input type="file" id="page_dialog_importer_file" accept="text/*" style="display:none" onchange="App.page_dialog_importer.up(this.files)">
    <div>
	<span class="icon-24" style="background-image: url(img/truncate.png);background-repeat: no-repeat" title="Очистить таблицу" onclick="App.page_dialog_importer.delete('all');"> </span>
	<span class="icon-24 icon-delete" title="Удалить выбранные строчки" onclick="App.page_dialog_importer.delete();"> </span>
	<span class="icon-24" style="background-image: url(img/file_upload.png);background-repeat: no-repeat" title="Отправить файл" onclick="$('#page_dialog_importer_file').click();"> </span>
	<span class="icon-24 icon-refresh" title="Обновить" onclick="$('#page_dialog_importer_dg').datagrid('reload')"> </span>
	<input id="page_dialog_importer_label" onkeyup="App.page_dialog_importer.filter(this)">
    </div>
    <table id="page_dialog_importer_dg" class="easyui-datagrid" data-options="
	    loader:App.page_dialog_importer.loader,
	    height:500,
	    rownumbers:true,
	    autoRowHeight:false,
	    pagination:true,
	    pageSize:100,
	    pageList:[100,500],
	    pagePosition:'bottom'">
	<thead>
	    <tr>
		<th data-options="field:'label',width:50">метка</th>
		<th data-options="field:'A',width:150">A</th>
		<th data-options="field:'B',width:150">B</th>
		<th data-options="field:'C',width:150">C</th>
		<th data-options="field:'D',width:150">D</th>
		<th data-options="field:'E',width:150">E</th>
		<th data-options="field:'F',width:150">F</th>
		<th data-options="field:'G',width:150">G</th>
		<th data-options="field:'H',width:150">H</th>
		<th data-options="field:'I',width:150">I</th>
		<th data-options="field:'K',width:150">K</th>
		<th data-options="field:'L',width:150">L</th>
		<th data-options="field:'M',width:150">M</th>
		<th data-options="field:'N',width:150">N</th>
		<th data-options="field:'O',width:150">O</th>
		<th data-options="field:'P',width:150">P</th>
		<th data-options="field:'Q',width:150">Q</th>
	    </tr>
	</thead>
    </table>
