<script>
    /*global App*/
    Ctree = App.page_company_tree = {
	properties: {
	    title: 'Дерево компаний',
	    width: 470,
	    height: 440,
	    modal: true,
	    onClose: function () {
		Ctree.handler.notify('close', Ctree.data);
		Ctree.node.window('destroy');
		Ctree.node.remove();
		delete App.page_company_tree, Ctree;
	    }
	},
	init: function () {
	    if (this.data.inline) {
		this.node.panel(Ctree.properties);
	    } else {
		this.node.window(Ctree.properties);
	    }
	},
	enableButtons:function( leaf ){
	    if( leaf ){
		Ctree.node.find('.ok').prop('disabled',false);
	    }
	    Ctree.node.find('.folder').prop('disabled',false);
	},
	select: function () {
	    var company=$('#Ctree_tree').tree('getSelected');
	    Ctree.handler.notify('select', company);
	},
	create:function( new_branch_type ){
	    var selected=$('#Ctree_tree').tree('getSelected');
	    var parent_id=selected.is_leaf*1?selected.parent_id:selected.branch_id;
	    var parent=parent_id>0?$('#Ctree_tree').tree('find', parent_id):$('#Ctree_tree').tree('getRoot');
	    var newlabel=(new_branch_type === 'leaf')?prompt("Введите Короткое название новой компании",'Новая компания'):prompt("Введите название новой группы",'Новая группа');
	    if( newlabel ){
		$.post('Company/companyCreateBranch/'+App.uri(parent_id,newlabel,new_branch_type),function(company_id){
		    if(new_branch_type === 'leaf'){
			Ctree.updateDetails(company_id,parent);
		    }
		    $('#Ctree_tree').tree('reload',parent.target);
		});
	    }
	},
	update:function(){
	    var node=$('#Ctree_tree').tree('getSelected');
	    if( node.company_id ){
		Ctree.updateDetails(node.company_id,node);
	    } else {
		var newlabel=prompt("Введите новое название группы: "+node.label,node.label);
		if( newlabel && newlabel!==node.label ){
		    $.post('Catalog/treeUpdate/companies_tree/'+App.uri(node.branch_id,'label',newlabel),function(ok){
			if( ok*1 ){
			    App.flash("Сохранено: название папки");
			    $('#Ctree_tree').tree('update', {target: node.target,text: newlabel});
			} else {
			    App.flash("Сохраненние не удалось: название папки");
			}
		    });
		}
	    }
	},
	updateDetails:function(company_id,parent){
	    App.loadWindow('page/company/details',{company_id:company_id,autoselect_label:true}).progress(function(status){
		if( status==='label_changed' ){
		    $('#Ctree_tree').tree('reload',parent.target);
		}
	    });
	},
	delete:function(){
	    var node=$('#Ctree_tree').tree('getSelected');
	    if( node && confirm() ){
		
	    }
	    alert(node.toSource());
	},
	reload:function(){
	    $('#Ctree_tree').tree('reload');
	    Ctree.node.find('.ok,.folder').prop('disabled',true);
	}
    };
</script>
<div style="width:450px;height: 360px;overflow: auto">
    <ul class="easyui-tree" id="Ctree_tree" data-options="
	url:'Company/branchFetch/',
	method:'get',
	loadFilter:function(data){
	    for(var i in data){
		data[i].id=data[i].branch_id;
		data[i].text=data[i].label;
		if(data[i].level!=0){
		    data[i].iconCls='icon-lock';
		}
	    }
	    return data;
	},
	onSelect:function(node){
	    if(node.state=='closed') {
		$(this).tree('expand',node.target);
		Ctree.enableButtons(0);
	    } else {
		Ctree.enableButtons(1);
	    }
	},
	onDblClick:Ctree.update,
	animate:true,
	dnd:true">
    </ul>
</div>
<div style="text-align: center">
    <button class="ok" disabled="disabled" onclick="Ctree.select()"><img src="img/apply24.png"> Выбрать</button> | 
    <button class="folder" disabled="disabled" onclick="Ctree.create('leaf')" title="Добавить компанию"><img src="img/edit_add.png"></button>
    <button class="folder" disabled="disabled" onclick="Ctree.create('folder')" title="Добавить папку"><img src="img/FolderAdd-24.png"></button>
    <button class="folder" disabled="disabled" onclick="Ctree.update()" title="Редактировать"><img src="img/Edit-24.png"></button>
    <button class="folder" disabled="disabled" onclick="Ctree.delete()" title="Удалить"><img src="img/delete.png"></button>
    <button onclick="Ctree.reload()" title="Обновить"><img src="img/reload.png"></button>
</div>