<script>
    /*global App*/
    Ctree = App.page_company_tree = {
	properties: {
	    title: 'Дерево компаний',
	    width: 470,
	    height: 440,
	    modal: true,
	    onClose: function () {
		Ctree.handler.notify('close', Ctree.data);
		Ctree.node.window('destroy');
		Ctree.node.remove();
		delete App.page_company_tree, Ctree;
	    }
	},
	init: function () {
	    if (this.data.inline) {
		this.node.panel(Ctree.properties);
	    } else {
		this.node.window(Ctree.properties);
	    }
	},
	enableButtons:function( leaf ){
	    if( leaf ){
		Ctree.node.find('.ok').prop('disabled',false);
	    }
	    Ctree.node.find('.folder').prop('disabled',false);
	},
	select: function () {
	    var company=$('#Ctree_tree').tree('getSelected');
	    Ctree.handler.notify('select', company);
	},
	create:function( branch_type ){
	    var node=$('#Ctree_tree').tree('getSelected');
	    var parent_id=node.is_leaf?node.parent_id:node.branch_id;
	    if( branch_type === 'folder' ){
		this.createFolder( branch_type, parent_id );
	    } else {
		var newlabel=prompt("Введите Короткое название новой компании",'Новая компания');
	    }

	},
	createFolder:function( branch_type, parent_id ){
	    var newlabel=prompt("Введите название новой группы",'Новая группа');
	    $.post('Catalog/treeCreate/companies_tree/'+App.uri(branch_type,parent_id,newlabel),function(branch_id){
		var parent=$('#Ctree_tree').tree('find', parent_id);
		$('#Ctree_tree').tree('append', {
		    parent: parent.target,
		    data:[
			{id: branch_id,text: newlabel}
		    ]});
	    });	    
	},
	update:function(){
	    var node=$('#Ctree_tree').tree('getSelected');
	    if( node.company_id ){
		App.loadWindow('page/company/details',node).progress(function(status){
		    Ctree.reload();
		});
	    } else {
		var newlabel=prompt("Введите новое название группы: "+node.label,node.label);
		if( newlabel ){
		    $.post('Catalog/treeUpdate/companies_tree/'+App.uri(node.branch_id,'label',newlabel),function(ok){
			if( ok*1 ){
			    App.flash("Сохранено: название папки");
			    $('#Ctree_tree').tree('update', {target: node.target,text: newlabel});
			} else {
			    App.flash("Сохраненние не удалось: название папки");
			}
		    });
		}
	    }
	},
	delete:function(node){
	    alert(node.toSource());
	},
	reload:function(){
	    $('#Ctree_tree').tree('reload');
	    Ctree.node.find('.ok,.folder').prop('disabled',true);
	}
    };
</script>
<div style="width:450px;height: 360px;overflow: auto">
    <ul class="easyui-tree" id="Ctree_tree" data-options="
	url:'Company/branchFetch/',
	method:'get',
	loadFilter:function(data){
	    for(var i in data){
		data[i].id=data[i].branch_id;
		data[i].text=data[i].label;
		if(data[i].level!=0){
		    data[i].iconCls='icon-lock';
		}
	    }
	    return data;
	},
	onSelect:function(node){
	    if(node.state=='closed') {
		$(this).tree('expand',node.target);
		Ctree.enableButtons(0);
	    } else {
		Ctree.enableButtons(1);
	    }
	},
	onDblClick:Ctree.update,
	animate:true,
	dnd:true">
    </ul>
</div>
<div style="text-align: center">
    <button class="ok" disabled="disabled" onclick="Ctree.select()"><img src="img/apply24.png"> Выбрать</button> | 
    <button class="folder" disabled="disabled" onclick="Ctree.create('leaf')" title="Добавить компанию"><img src="img/edit_add.png"></button>
    <button class="folder" disabled="disabled" onclick="Ctree.create('folder')" title="Добавить папку"><img src="img/FolderAdd-24.png"></button>
    <button class="folder" disabled="disabled" onclick="Ctree.update()" title="Редактировать"><img src="img/Edit-24.png"></button>
    <button class="folder" disabled="disabled" onclick="Ctree.delete()" title="Удалить"><img src="img/delete.png"></button>
    <button onclick="Ctree.reload()" title="Обновить"><img src="img/reload.png"></button>
</div>