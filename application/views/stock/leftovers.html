<script type="text/javascript">
    /* global App */
    Leftovers=App.page_stock_leftovers={
	init:function(){
	    this.initTree();
	    Leftovers.list.toggleFilter();
	},
	initTree:function(){
	    App.loadModule('page/stock/tree',{inline:true,clickselect:true},'StreeInline',/(Stree|page_stock_tree)([^\w]|_)/g,"StreeInline$2").progress(function(status,branch){
		if( status==='select' ){
		    Leftovers.list.loadParent(branch?branch.branch_id:0,branch?branch.label:'Все');
		}
	    });
	},
        initAfter:function(){
            this.list.checkHide();
        },
	focus:function(){
	    this.load();
	},
	list:{
	    parent_id:0,
	    filterRules:{},
	    currPage:1,
	    loader:function( param, success, error ){
		Leftovers.list.filterRules=param.filterRules;
		Leftovers.list.currPage=param.page;
		$.get("Stock/listFetch/"+App.uri(param.page,param.rows,Leftovers.list.parent_id), {filterRules: Leftovers.list.filterRules},function( xhr ){
		    var resp=App.json(xhr);
		    resp=Leftovers.list.calc.calcTable(resp);
		    success(resp);
		});
	    },
	    calc:{
		calcTable:function( resp ){
		    for(var i in resp.rows ){
			resp.rows[i].m1=this.clear(resp.rows[i].m1);
			resp.rows[i].m3=this.clear(resp.rows[i].m3);
			resp.rows[i].product_spack=this.clear(resp.rows[i].product_spack);
			resp.rows[i].product_bpack=this.clear(resp.rows[i].product_bpack);
			resp.rows[i].product_quantity=this.clear(resp.rows[i].product_quantity);
			resp.rows[i].product_wrn_quantity=this.clear(resp.rows[i].product_wrn_quantity);
			resp.rows[i].product_weight=this.round(resp.rows[i].product_weight,5);
			resp.rows[i].product_volume=this.round(resp.rows[i].product_volume,5);
			resp.rows[i].self_price=this.round(resp.rows[i].self_price,2);
			resp.rows[i].sell=this.round(resp.rows[i].sell,2);
			resp.rows[i].buy=this.round(resp.rows[i].buy,2);
		    }
		    return resp;
		},
		clear:function(value){
		    return value*1||'';
		},
		round:function(value,precision){
		    return Number(value).toFixed(precision);
		},
		left:function(value,row){
		    if( row.product_quantity*2<row.product_wrn_quantity ){
			return 'background-color:#f9f';
		    } 
		    if( row.product_quantity<row.product_wrn_quantity ){
			return 'background-color:#fcf';
		    } 
		},
		m1:function(value,row){
		    if( row.m1*1<row.m3*1 ){
			return 'color:red';
		    }
		    return 'color:green';
		}
	    },
            checkHide: function(){
                if ( App.user.props.user_level>=3 ) {
                    $('#stock_dg').datagrid('showColumn','sell');
                    $('#stock_dg').datagrid('showColumn','buy');
                    $('#stock_dg').datagrid('showColumn','curr_code');
                    $('#stock_dg').datagrid('showColumn','self_price');
                }
                else {
                    $('#stock_dg').datagrid('hideColumn','sell');
                    $('#stock_dg').datagrid('hideColumn','buy');
                    $('#stock_dg').datagrid('hideColumn','curr_code');
                    $('#stock_dg').datagrid('hideColumn','self_price');
                }	    
            },
	    reload:function(){
		$("#stock_dg").datagrid('reload');
	    },
	    out:function( out_type ){
		var params={
		    page:Leftovers.list.currPage,
		    parent_id:Leftovers.list.parent_id,
		    filterRules:Leftovers.list.filterRules,
		    out_type:out_type
		};
		var url='StockView/stockViewGet/?'+$.param( params );
		if( out_type==='print' ){
		    window.open(url,'print_tab');
		} else {
		    location.href=url;
		}
	    },
	    edit:function(index,field,value){
		var row=$("#stock_dg").datagrid('getSelected');
		if( row ){
		    row.focus=field;
		    Leftovers.list.showProductCard(row);
		}
	    },
	    create:function(){
		var fvalue={
		    parent_id:Leftovers.list.parent_id,
		    parent_label:Leftovers.list.parent_label,
		    product_code:''
		};
		Leftovers.list.showProductCard(fvalue);
	    },
	    showProductCard:function( fvalue ){
		if( App.user.props.user_level<2 ){
		    alert("Доступ ограничен");
		    return;
		}
		App.loadWindow('page/stock/product_card',fvalue).progress(function(status,fvalue){
		    if( status==='submit' ){
			$.post('Stock/productSave/',fvalue,function(ok){
			    if( ok*1 ){
				App.flash("Свойства товара сохранены");
				Leftovers.list.reload();
			    } else {
				App.flash("Свойства товара не изменились");
			    }
			});
		    }
		});
	    },
	    delete:function(){
		var row=$("#stock_dg").datagrid('getSelected');
		if( row && row.product_quantity>0 ){
		    alert("Остаток '"+row.ru+"' должен быть нулевым");
		    return;
		}
		if( row && confirm("Удалить '"+row.ru+"' со списка склада?") ){
		    $.post('Stock/productDelete/',{product_code:row.product_code},function(ok){
			if( ok*1 ){
			    App.flash("Товар удален: "+row.ru);
			    Leftovers.list.reload();
			} else {
			    App.flash("Товар не удален");
			}
		    });
		}
		
	    },
	    loadParent:function( parent_id,label ){
		this.parent_id=parent_id;
		this.parent_label=label;
		$("#stock_cat_name").html(this.parent_label);
		this.reload();
	    },
	    toggleFilter: function () {
		if (this.filterEnabled) {
		    $('#stock_dg').datagrid('disableFilter');
		    this.filterEnabled = false;
		}
		else {
		    $('#stock_dg').datagrid('enableFilter');
		    this.filterEnabled = true;
		}
	    }
	}
    };
</script>
<table style="min-width:500px">
    <tr>
	<td style="vertical-align: top">
	    Категории товара
	    <hr>
	    <div id="StreeInline"></div>
	</td>
	<td style="vertical-align: top">
	    <div style="float: left;font-weight: bold;padding-top: 8px;">
		<img src="img/table16.png" style="width:16px;height: 16px;"> Остатки в категории: "<span id="stock_cat_name">Все</span>"
	    </div>
	    <div style="text-align: right;padding-right: 5px;">
		<span class="icon-24 icon-create" title="Добавить" onclick="Leftovers.list.create();"> </span>
		<span class="icon-24 icon-change" title="Изменить" onclick="Leftovers.list.edit();"> </span>
		<span class="icon-24 icon-delete" title="Удалить" onclick="Leftovers.list.delete();"> </span>
		<span class="icon-24 icon-tablefilter" title="Фильтр таблицы" onclick="Leftovers.list.toggleFilter()"> </span>
		<span class="icon-24 icon-refresh" title="Обновить" onclick="Leftovers.list.reload()"> </span>
		<span class="icon-24" style="background-image: url(img/file_download.png);background-repeat: no-repeat" title="Скачать таблицу" onclick="Leftovers.list.out('.xlsx');"> </span>
		<span class="icon-24 icon-print" title="Печать" onclick="Leftovers.list.out('print')"> </span>
	    </div>
	    <table class="easyui-datagrid" id="stock_dg" style="width:780px" data-options="
		    loader:Leftovers.list.loader,
		    pagination:true,
		    pageSize:30,
		    pageList:[30,60,120,600],
		    singleSelect:true,
		    autoRowHeight:false,
		    remoteFilter:true,
		    onSelect:function(){$('#stock_dg').datagrid('resize');},
		    onDblClickCell:Leftovers.list.edit">
		<thead data-options="frozen:true">
		    <tr>
			<th data-options="field:'parent_label',width:120">Категория</th>
			<th data-options="field:'product_code',width:80">Код</th>
		    </tr>
		</thead>
		<thead>
		    <tr>
			<th data-options="field:'ru',width:330">Название</th>
			<th data-options="field:'product_quantity',width:70,align:'right',styler:Leftovers.list.calc.left">Остаток</th>
			<th data-options="field:'product_unit',width:30,align:'left'">Ед</th>
			<th data-options="field:'product_wrn_quantity',width:50,align:'right'">Мин</th>
			<th data-options="field:'m1',width:50,align:'right',styler:Leftovers.list.calc.m1">1м</th>
			<th data-options="field:'m3',width:50,align:'right'">3м</th>
			<th data-options="field:'self_price',width:50,align:'right',hidden:true">Учетная ц.</th>
			<th data-options="field:'sell',width:50,align:'right',hidden:true">Продажа</th>
			<th data-options="field:'buy',width:50,align:'right',hidden:true">Покупка</th>
			<th data-options="field:'curr_code',width:50,align:'right',hidden:true">Валюта</th>
			<th data-options="field:'product_spack',width:50,align:'right'">М. упак</th>
			<th data-options="field:'product_bpack',width:50,align:'right',">Б. упак</th>
			<th data-options="field:'product_weight',width:70,align:'right'">Вес кг</th>
			<th data-options="field:'product_volume',width:70,align:'right'">Объем м3</th>
			<th data-options="field:'party_label',width:100">Партия</th>
			<th data-options="field:'product_uktzet',width:100,align:'right'">Таможенный код</th>
			<th data-options="field:'barcode',width:100,align:'right'">Штрихкод</th>
		    </tr>
		</thead>
	    </table>
	</td>
    </tr>
</table>
